<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ball Tower Jumper">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    <title>Ball Tower Jumper</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div id="game-container">
        <div id="start-screen" class="screen active">
            <div class="title-container">
                <h1 class="game-title">BALL TOWER JUMPER</h1>
                <div class="title-ball"></div>
                <p class="tagline">Play, change balls, buy upgrades!</p>
            </div>
            
            <div class="menu-buttons">
                <button id="play-btn" class="menu-btn">
                    <i class="fas fa-play"></i> Play
                </button>
                <button id="balls-btn" class="menu-btn">
                    <i class="fas fa-basketball-ball"></i> Choose Ball
                </button>
                <button id="upgrades-btn" class="menu-btn">
                    <i class="fas fa-sliders-h"></i> Upgrades
                </button>
                <button id="settings-btn" class="menu-btn">
                    <i class="fas fa-cogs"></i> Settings
                </button>
            </div>
            
            <div class="stats-bar">
                <div class="stat">
                    <i class="fas fa-coins"></i>
                    <span id="total-coins">0</span>
                </div>
                <div class="stat">
                    <i class="fas fa-arrow-up"></i>
                    Highscore: <span id="best-score">0</span>
                </div>
                <div class="stat">
                    <i class="fas fa-basketball-ball"></i>
                    Unlocked Balls: <span id="unlocked-balls">1/4</span>
                </div>
            </div>
        </div>
        
        <div id="balls-screen" class="screen">
            <div class="screen-header">
                <button class="back-btn"><i class="fas fa-arrow-left"></i> Back</button>
                <div class="header-actions">
                        <h2><i class="fas fa-basketball-ball"></i> Choose ball</h2>
                    <div class="coins-display">
                        <i class="fas fa-coins"></i> <span id="balls-coins">0</span>
                    </div>
                </div>
            </div>
            
            <div class="balls-container">
                <div class="ball-card active" data-ball="standard">
                    <div class="ball-preview standard-ball"></div>
                    <h3>Standard</h3>
                    <p>Standard ball, normal physics, perfect for start</p>
                    <div class="ball-stats">
                    </div>
                    <button class="select-ball-btn">Selected</button>
                </div>
                
                <div class="ball-card locked" data-ball="rubber">
                    <div class="ball-preview rubber-ball">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h3>Gumball</h3>
                    <p>High Wall Boost</p>
                    <div class="ball-stats">
                    </div>
                    <button class="unlock-btn" data-cost="50">Unlock for 50 <i class="fas fa-coins"></i></button>
                </div>
                
                <div class="ball-card locked" data-ball="beach">
                    <div class="ball-preview beach-ball">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h3>Beach Ball</h3>
                    <p>Sensitive to wind</p>
                    <button class="unlock-btn" data-cost="100">Unlock for 100 <i class="fas fa-coins"></i></button>
                </div>
                
                <div class="ball-card locked" data-ball="golf">
                    <div class="ball-preview golf-ball">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h3>Golf</h3>
                    <p>Cannon Access</p>
                    <button class="unlock-btn" data-cost="150">Unlock for 150 <i class="fas fa-coins"></i></button>
                </div>
            </div>
            
            <div class="selected-ball-info">
                <h3>Selected ball: <span id="current-ball-name">Standard</span></h3>
            </div>
        </div>
        
        <div id="upgrades-screen" class="screen">
            <div class="screen-header">
                <button class="back-btn"><i class="fas fa-arrow-left"></i> Back</button>
                <div class="header-actions">
                        <h2><i class="fas fa-cogs"></i> Upgrades</h2>
                    <div class="coins-display">
                        <i class="fas fa-coins"></i> <span id="upgrades-coins">0</span>
                    </div>
                </div>
            </div>
            
            <div class="ball-selector">
                <h3>Select ball to upgrade:</h3>
                <div class="ball-selector-buttons">
                </div>
            </div>
            
            <div id="upgrades-list">
            </div>
            
            <div class="upgrades-info">
                <p><i class="fas fa-info-circle"></i> Upgrades can be enabled/disabled before starting the game. They are specific to each ball.</p>
            </div>
        </div>
        
        <div id="settings-screen" class="screen">
            <div class="screen-header">
                <button class="back-btn"><i class="fas fa-arrow-left"></i> Back</button>
                <h2><i class="fas fa-sliders-h"></i> Settings</h2>
            </div>
            
            <div class="settings-content">
                <div class="settings-section">
                    <h3><i class="fas fa-gamepad"></i> Controls</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Auto jump</h4>
                            <p>Ball jumps automatically after landing</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="auto-jump-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Mobile controls</h4>
                            <p>Enable touch controls (left/right side of screen)</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="mobile-controls-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Accelerometer</h4>
                            <p>Use device tilt to control</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="accelerometer-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Show wind</h4>
                            <p>Display wind direction and strength arrow</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="wind-display-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3><i class="fas fa-bug"></i> Debug</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Show debug info</h4>
                            <p>Show debugging information during the game</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="debug-info-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Add coins (debug)</h4>
                            <p>Add 1000 coins to test purchases</p>
                        </div>
                        <button id="add-coins-btn" class="debug-btn">
                            <i class="fas fa-coins"></i> Add 1000 coins
                        </button>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Reset progress</h4>
                            <p>Delete all saved data and start over</p>
                        </div>
                        <button id="reset-progress-btn" class="danger-btn">
                            <i class="fas fa-trash"></i> Reset progress
                        </button>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Request Accelerometer Access</h4>
                            <p>Tap to enable tilt controls on iOS</p>
                        </div>
                        <button id="request-accelerometer-btn" class="debug-btn">
                            <i class="fas fa-compass"></i> Request Access
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="game-screen" class="screen">
            <canvas id="game-canvas"></canvas>
            
            <div id="debug-info" class="debug-info hidden">
                <div id="height-display">Height: <span id="height">0</span>px</div>
                <div id="max-height-display">Max height: <span id="max-height">0</span>px</div>
                <div id="velocity-x-display">Velocity X: <span id="velocity-x">0</span>px/frame</div>
                <div id="max-velocity-x-display">Max velocity X: <span id="max-velocity-x">0</span>px/frame</div>
                <div id="velocity-y-display">Velocity Y (up): <span id="velocity-y">0</span>px/frame</div>
                <div id="max-velocity-y-display">Max velocity Y (up): <span id="max-velocity-y">0</span>px/frame</div>
                <div id="current-floor-display">Current floor: <span id="current-floor">0</span></div>
                <div id="max-floor-display">Highest floor: <span id="max-floor">0</span></div>
                <div id="high-score-display">High score: <span id="high-score">0</span></div>
            </div>
            
            <div id="game-hud">
                <div class="hud-top">
                    <div class="hud-left">
                        <button id="pause-btn" class="hud-btn" title="Pause (P)">
                            <i class="fas fa-pause"></i>
                        </button>
                    </div>
                    
                    <div class="hud-center">
                        <div class="score-display">
                            Score: <span id="score-value">0</span>
                        </div>
                    </div>
                    
                    <div class="hud-right">
                        <div class="hud-item">
                            <i class="fas fa-coins"></i>
                            <span id="coins-value">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="pause-menu" class="overlay-menu hidden">
                <div class="pause-content">
                    <h2><i class="fas fa-pause"></i> Game Paused</h2>
                    <div class="pause-stats">
                        <div class="stat-box">
                            <h3>Score</h3>
                            <p class="stat-value" id="pause-score">0</p>
                        </div>
                        <div class="stat-box">
                            <h3>Coins</h3>
                            <p class="stat-value" id="pause-coins">0</p>
                        </div>
                        <div class="stat-box">
                            <h3>Ball</h3>
                            <p class="stat-value" id="pause-ball">Standard</p>
                        </div>
                    </div>
                    <div class="pause-buttons">
                        <button id="resume-btn" class="pause-btn">
                            <i class="fas fa-play"></i> Resume Game
                        </button>
                        <button id="restart-btn" class="pause-btn">
                            <i class="fas fa-redo"></i> Start Over
                        </button>
                        <button id="quit-to-menu-btn" class="pause-btn">
                            <i class="fas fa-home"></i> Exit to Menu
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="game-over-screen" class="overlay-menu hidden">
                <div class="game-over-content">
                    <h2><i class="fas fa-skull-crossbones"></i> Fell!</h2>
                    <div class="game-over-stats">
                        <div class="stat-box">
                            <h3>Your Score</h3>
                            <p class="stat-value" id="final-score">0</p>
                        </div>
                        <div class="stat-box">
                            <h3>Coins Collected</h3>
                            <p class="stat-value" id="final-coins">0</p>
                        </div>
                        <div class="stat-box">
                            <h3>High Score</h3>
                            <p class="stat-value" id="final-highscore">0</p>
                        </div>
                    </div>
                    
                    <div class="game-over-buttons">
                        <button id="play-again-btn" class="game-over-btn">
                            <i class="fas fa-redo"></i> Play Again
                        </button>
                        <button id="quit-after-game-btn" class="game-over-btn">
                            <i class="fas fa-home"></i> Main Menu
                        </button>
                    </div>
                    
                    <div class="game-over-message">
                        <p id="game-over-message-text">Try again!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification-container"></div>
    
    <script src="js/config.js"></script>
    <script src="js/menu.js"></script>
    <script src="js/game.js"></script>
    
    <script>
        function updateSafeArea() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
            
            const isStandalone = window.navigator.standalone || 
                                (window.matchMedia('(display-mode: standalone)').matches);
            
            if (isStandalone) {
                document.body.classList.add('standalone');
                console.log('Running in standalone mode');
                
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                if (isIOS) {
                    const width = window.screen.width;
                    const height = window.screen.height;
                    
                    if ((width === 393 && height === 852) || (width === 430 && height === 932)) {
                        document.documentElement.style.setProperty('--safe-area-inset-top', '59px');
                        document.documentElement.style.setProperty('--safe-area-inset-bottom', '34px');
                    } else {
                        document.documentElement.style.setProperty('--safe-area-inset-top', '47px');
                        document.documentElement.style.setProperty('--safe-area-inset-bottom', '34px');
                    }
                }
            } else {
                document.body.classList.remove('standalone');
            }
            
            if (window.Menu && window.Menu.updateUI) {
                setTimeout(() => window.Menu.updateUI(), 100);
            }
            
            if (window.Game && window.Game.resizeCanvas) {
                setTimeout(() => window.Game.resizeCanvas(), 100);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                updateSafeArea();
                
                if (window.Menu) Menu.init();
                
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./service-worker.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful');
                        })
                        .catch(err => {
                            console.log('ServiceWorker registration failed: ', err);
                        });
                }
            }, 100);
            
            document.addEventListener('touchmove', function(e) {
                if(e.target.type === 'range') return;
                e.preventDefault();
            }, { passive: false });
            
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
        });

        window.addEventListener('resize', updateSafeArea);
        window.addEventListener('orientationchange', () => {
            setTimeout(updateSafeArea, 350);
        });

        let lastWindowHeight = window.innerHeight;
        let resizeTimer;
        
        window.addEventListener('resize', () => {
            const currentHeight = window.innerHeight;
            
            if (Math.abs(currentHeight - lastWindowHeight) > 50) {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    updateSafeArea();
                    lastWindowHeight = currentHeight;
                }, 250);
            }
        });

        setTimeout(updateSafeArea, 1000);
    </script>
</body>
</html>