<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- W <head> pliku index.html: -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ball Tower Jumper">

    <!-- Dodaj touch icons dla iOS -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="mask-icon" href="safari-pinned-tab.svg" color="#1a1a2e">
    <meta name="msapplication-TileColor" content="#1a1a2e">
    <meta name="theme-color" content="#1a1a2e">

    <!-- Zmień sekcję PWA w head -->
    <link rel="manifest" href="manifest.json">
    <!-- Dodaj fallback dla iOS -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ball Tower Jumper">
    <title>Ball Tower Jumper</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    
    <!-- Critical CSS inline for better performance -->
    <style>
        /* Prevent double-tap zoom on iOS */
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        /* iOS standalone specific fixes */
        @supports (-webkit-touch-callout: none) {
            .screen {
                -webkit-overflow-scrolling: touch;
            }
            
            button, [role="button"] {
                cursor: pointer;
            }
        }
        
        /* Prevent text selection */
        .no-select {
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Hide scrollbar but keep functionality */
        .scrollable::-webkit-scrollbar {
            display: none;
        }
        
        .scrollable {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <!-- Game Container -->
    <div id="game-container">
        <!-- Start Screen (Main Menu) -->
        <div id="start-screen" class="screen active">
            <div class="title-container">
                <h1 class="game-title">BALL TOWER JUMPER</h1>
                <div class="title-ball"></div>
                <p class="tagline">Play, change balls, buy upgrades!</p>
            </div>
            
            <div class="menu-buttons">
                <button id="play-btn" class="menu-btn" data-action="play">
                    <i class="fas fa-play"></i> Play
                </button>
                <button id="balls-btn" class="menu-btn" data-action="balls">
                    <i class="fas fa-basketball-ball"></i> Choose Ball
                </button>
                <button id="upgrades-btn" class="menu-btn" data-action="upgrades">
                    <i class="fas fa-sliders-h"></i> Upgrades
                </button>
                <button id="settings-btn" class="menu-btn" data-action="settings">
                    <i class="fas fa-cogs"></i> Settings
                </button>
            </div>
            
            <!-- STATS BAR MOVED TO BOTTOM -->
            <div class="stats-bar">
                <div class="stat">
                    <i class="fas fa-coins"></i>
                    <span id="total-coins">0</span>
                </div>
                <div class="stat">
                    <i class="fas fa-arrow-up"></i>
                    Highscore: <span id="best-score">0</span>
                </div>
                <div class="stat">
                    <i class="fas fa-basketball-ball"></i>
                    Unlocked Balls: <span id="unlocked-balls">1/4</span>
                </div>
            </div>
        </div>
        
        <!-- Ball Selection Screen -->
        <div id="balls-screen" class="screen">
            <div class="screen-header">
                <button class="back-btn" data-target="start"><i class="fas fa-arrow-left"></i> Back</button>
                <div class="header-actions">
                        <h2><i class="fas fa-basketball-ball"></i> Choose ball</h2>
                    <div class="coins-display">
                        <i class="fas fa-coins"></i> <span id="balls-coins">0</span>
                    </div>
                </div>
            </div>
            
            <div class="screen-body scrollable">
                <div class="balls-container">
                    <!-- Standard ball -->
                    <div class="ball-card active" data-ball="standard">
                        <div class="ball-preview standard-ball"></div>
                        <h3>Standard</h3>
                        <p>Standard ball, normal physics, perfect for start</p>
                        <div class="ball-stats">
                        </div>
                        <button class="select-ball-btn" data-action="select-ball" data-ball="standard">Selected</button>
                    </div>
                    
                    <!-- Rubber ball -->
                    <div class="ball-card locked" data-ball="rubber">
                        <div class="ball-preview rubber-ball">
                            <i class="fas fa-lock"></i>
                        </div>
                        <h3>Gumball</h3>
                        <p>High Wall Boost</p>
                        <div class="ball-stats">
                        </div>
                        <button class="unlock-btn" data-cost="50" data-action="unlock-ball" data-ball="rubber">Unlock for 50 <i class="fas fa-coins"></i></button>
                    </div>
                    
                    <!-- Beach ball -->
                    <div class="ball-card locked" data-ball="beach">
                        <div class="ball-preview beach-ball">
                            <i class="fas fa-lock"></i>
                        </div>
                        <h3>Beach Ball</h3>
                        <p>Sensitive to wind</p>
                        <button class="unlock-btn" data-cost="100" data-action="unlock-ball" data-ball="beach">Unlock for 100 <i class="fas fa-coins"></i></button>
                    </div>
                    
                    <!-- Golf ball -->
                    <div class="ball-card locked" data-ball="golf">
                        <div class="ball-preview golf-ball">
                            <i class="fas fa-lock"></i>
                        </div>
                        <h3>Golf</h3>
                        <p>Cannon Access</p>
                        <button class="unlock-btn" data-cost="150" data-action="unlock-ball" data-ball="golf">Unlock for 150 <i class="fas fa-coins"></i></button>
                    </div>
                </div>
                
                <div class="selected-ball-info">
                    <h3>Selected ball: <span id="current-ball-name">Standard</span></h3>
                </div>
            </div>
        </div>
        
        <!-- Upgrades Screen -->
        <div id="upgrades-screen" class="screen">
            <div class="screen-header">
                <button class="back-btn" data-target="start"><i class="fas fa-arrow-left"></i> Back</button>
                <div class="header-actions">
                        <h2><i class="fas fa-cogs"></i> Upgrades</h2>
                    <div class="coins-display">
                        <i class="fas fa-coins"></i> <span id="upgrades-coins">0</span>
                    </div>
                </div>
            </div>
            
            <div class="screen-body scrollable">
                <div class="ball-selector">
                    <h3>Select ball to upgrade:</h3>
                    <div class="ball-selector-buttons">
                        <!-- Ball selection buttons will be generated dynamically -->
                    </div>
                </div>
                
                <div id="upgrades-list">
                    <!-- Upgrades list will be generated dynamically -->
                </div>
                
                <div class="upgrades-info">
                    <p><i class="fas fa-info-circle"></i> Upgrades can be enabled/disabled before starting the game. They are specific to each ball.</p>
                </div>
            </div>
        </div>
        
        <!-- Settings Screen -->
        <div id="settings-screen" class="screen">
            <div class="screen-header">
                <button class="back-btn" data-target="start"><i class="fas fa-arrow-left"></i> Back</button>
                <h2><i class="fas fa-sliders-h"></i> Settings</h2>
            </div>
            
            <div class="screen-body scrollable">
                <div class="settings-section">
                    <h3><i class="fas fa-gamepad"></i> Controls</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Auto jump</h4>
                            <p>Ball jumps automatically after landing</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="auto-jump-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Mobile controls</h4>
                            <p>Enable touch controls (left/right side of screen)</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="mobile-controls-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Accelerometer</h4>
                            <p>Use device tilt to control</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="accelerometer-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Show wind</h4>
                            <p>Display wind direction and strength arrow</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="wind-display-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3><i class="fas fa-bug"></i> Debug</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Show debug info</h4>
                            <p>Show debugging information during the game</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="debug-info-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Add coins (debug)</h4>
                            <p>Add 1000 coins to test purchases</p>
                        </div>
                        <button id="add-coins-btn" class="debug-btn" data-action="add-coins">
                            <i class="fas fa-coins"></i> Add 1000 coins
                        </button>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Reset progress</h4>
                            <p>Delete all saved data and start over</p>
                        </div>
                        <button id="reset-progress-btn" class="danger-btn" data-action="reset-progress">
                            <i class="fas fa-trash"></i> Reset progress
                        </button>
                    </div>
                    <!-- W pliku index.html, w sekcji ustawień dodaj: -->
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Request Accelerometer Access</h4>
                            <p>Tap to enable tilt controls on iOS</p>
                        </div>
                        <button id="request-accelerometer-btn" class="debug-btn" data-action="request-accelerometer">
                            <i class="fas fa-compass"></i> Request Access
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <canvas id="game-canvas"></canvas>
            
            <!-- Debug elements from the first project -->
            <div id="debug-info" class="debug-info hidden">
                <div id="height-display">Height: <span id="height">0</span>px</div>
                <div id="max-height-display">Max height: <span id="max-height">0</span>px</div>
                <div id="velocity-x-display">Velocity X: <span id="velocity-x">0</span>px/frame</div>
                <div id="max-velocity-x-display">Max velocity X: <span id="max-velocity-x">0</span>px/frame</div>
                <div id="velocity-y-display">Velocity Y (up): <span id="velocity-y">0</span>px/frame</div>
                <div id="max-velocity-y-display">Max velocity Y (up): <span id="max-velocity-y">0</span>px/frame</div>
                <div id="current-floor-display">Current floor: <span id="current-floor">0</span></div>
                <div id="max-floor-display">Highest floor: <span id="max-floor">0</span></div>
                <div id="high-score-display">High score: <span id="high-score">0</span></div>
            </div>
            
            <!-- SIMPLIFIED GAME HUD -->
            <div id="game-hud">
                <!-- Top HUD bar -->
                <div class="hud-top">
                    <div class="hud-left">
                        <button id="pause-btn" class="hud-btn" title="Pause (P)" data-action="pause">
                            <i class="fas fa-pause"></i>
                        </button>
                    </div>
                    
                    <div class="hud-center">
                        <div class="score-display">
                            Score: <span id="score-value">0</span>
                        </div>
                    </div>
                    
                    <div class="hud-right">
                        <div class="hud-item">
                            <i class="fas fa-coins"></i>
                            <span id="coins-value">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile Controls Overlay -->
                <div id="mobile-controls-overlay" class="mobile-controls-overlay">
                    <div class="control-left" id="control-left" data-action="move-left"></div>
                    <div class="control-right" id="control-right" data-action="move-right"></div>
                </div>
            </div>
            
            <!-- Pause menu -->
            <div id="pause-menu" class="overlay-menu hidden">
                <div class="overlay-background"></div> <!-- Added background -->
                <div class="pause-content">
                    <h2><i class="fas fa-pause"></i> Game Paused</h2>
                    <div class="pause-stats">
                        <div class="stat-box">
                            <h3>Score</h3>
                            <p class="stat-value" id="pause-score">0</p>
                        </div>
                        <div class="stat-box">
                            <h3>Coins</h3>
                            <p class="stat-value" id="pause-coins">0</p>
                        </div>
                        <div class="stat-box">
                            <h3>Ball</h3>
                            <p class="stat-value" id="pause-ball">Standard</p>
                        </div>
                    </div>
                    <div class="pause-buttons">
                        <button id="resume-btn" class="pause-btn" data-action="resume">
                            <i class="fas fa-play"></i> Resume Game
                        </button>
                        <button id="restart-btn" class="pause-btn" data-action="restart">
                            <i class="fas fa-redo"></i> Start Over
                        </button>
                        <button id="quit-to-menu-btn" class="pause-btn" data-action="quit-to-menu">
                            <i class="fas fa-home"></i> Exit to Menu
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Game over screen -->
            <div id="game-over-screen" class="overlay-menu hidden">
                <div class="overlay-background"></div> <!-- Added background -->
                <div class="game-over-content">
                    <h2><i class="fas fa-skull-crossbones"></i> Fell!</h2>
                    <div class="game-over-stats">
                        <div class="stat-box">
                            <h3>Your Score</h3>
                            <p class="stat-value" id="final-score">0</p>
                        </div>
                        <div class="stat-box">
                            <h3>Coins Collected</h3>
                            <p class="stat-value" id="final-coins">0</p>
                        </div>
                        <div class="stat-box">
                            <h3>High Score</h3>
                            <p class="stat-value" id="final-highscore">0</p>
                        </div>
                    </div>
                    
                    <div class="game-over-buttons">
                        <button id="play-again-btn" class="game-over-btn" data-action="play-again">
                            <i class="fas fa-redo"></i> Play Again
                        </button>
                        <button id="quit-after-game-btn" class="game-over-btn" data-action="quit-after-game">
                            <i class="fas fa-home"></i> Main Menu
                        </button>
                    </div>
                    
                    <div class="game-over-message">
                        <p id="game-over-message-text">Try again!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notifications -->
    <div id="notification-container"></div>
    
    <!-- JavaScript Scripts -->
    <script src="js/config.js"></script>
    <script src="js/menu.js"></script>
    <script src="js/game.js"></script>
    
    <!-- Enhanced iOS Standalone and Touch Handling -->
    <script>
        (function() {
            'use strict';
            
            // Singleton App Manager for iOS/PWA
            window.AppManager = {
                isStandalone: window.navigator.standalone,
                isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream,
                lastClickTime: 0,
                clickDebounceDelay: 400, // Increased for iOS standalone
                
                init() {
                    console.log('AppManager: Initializing for', this.isIOS ? 'iOS' : 'Other');
                    
                    // Register Service Worker
                    this.registerServiceWorker();
                    
                    // Apply platform-specific fixes
                    this.applyPlatformFixes();
                    
                    // Setup global event listeners
                    this.setupGlobalListeners();
                    
                    // Update safe area
                    this.updateSafeArea();
                    
                    // Initialize after DOM is ready
                    setTimeout(() => this.initializeApp(), 100);
                },
                
                registerServiceWorker() {
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.register('/service-worker.js')
                            .then(registration => {
                                console.log('ServiceWorker registered:', registration.scope);
                            })
                            .catch(err => {
                                console.log('ServiceWorker registration failed:', err);
                            });
                    }
                },
                
                applyPlatformFixes() {
                    // iOS specific fixes
                    if (this.isIOS) {
                        // Prevent elastic scrolling
                        document.body.style.overscrollBehavior = 'none';
                        
                        // Prevent zoom on double-tap
                        document.addEventListener('touchstart', (e) => {
                            if (e.touches.length > 1) {
                                e.preventDefault();
                            }
                        }, { passive: false });
                        
                        // Prevent scrolling when touching inputs
                        document.addEventListener('touchmove', (e) => {
                            if (e.target.type === 'range') return;
                            e.preventDefault();
                        }, { passive: false });
                        
                        // Fix for standalone mode
                        if (this.isStandalone) {
                            document.body.classList.add('standalone');
                            console.log('Running in iOS standalone mode');
                            
                            // Additional standalone fixes
                            this.applyStandaloneFixes();
                        }
                    }
                },
                
                applyStandaloneFixes() {
                    // Fix for double-tap zoom in standalone
                    let lastTouchEnd = 0;
                    document.addEventListener('touchend', (e) => {
                        const now = Date.now();
                        if (now - lastTouchEnd < 300) {
                            e.preventDefault();
                        }
                        lastTouchEnd = now;
                    }, false);
                    
                    // Prevent context menu on long press
                    document.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        return false;
                    });
                },
                
                setupGlobalListeners() {
                    // Global click debouncing to prevent double-tap
                    document.addEventListener('click', (e) => {
                        const now = Date.now();
                        if (now - this.lastClickTime < this.clickDebounceDelay) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('Click debounced');
                            return;
                        }
                        this.lastClickTime = now;
                    }, true);
                    
                    // Handle orientation changes
                    window.addEventListener('resize', () => this.updateSafeArea());
                    window.addEventListener('orientationchange', () => {
                        setTimeout(() => {
                            this.updateSafeArea();
                            if (window.Game && Game.resizeCanvas) {
                                Game.resizeCanvas();
                            }
                        }, 100);
                    });
                    
                    // Prevent zoom with Ctrl+/- or pinch
                    document.addEventListener('wheel', (e) => {
                        if (e.ctrlKey) e.preventDefault();
                    }, { passive: false });
                    
                    document.addEventListener('gesturestart', (e) => e.preventDefault());
                    document.addEventListener('gesturechange', (e) => e.preventDefault());
                    document.addEventListener('gestureend', (e) => e.preventDefault());
                },
                
                updateSafeArea() {
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                    
                    // Dynamic safe area for different iPhones
                    if (this.isIOS) {
                        const height = window.innerHeight;
                        let topInset = '47px';
                        let bottomInset = '34px';
                        
                        // iPhone 14/15 Pro Max with Dynamic Island
                        if (height >= 932 || height >= 852) {
                            topInset = '59px';
                            bottomInset = '34px';
                        }
                        // iPhone X/XS/11 Pro/12/13
                        else if (height >= 844 || height >= 896) {
                            topInset = '47px';
                            bottomInset = '34px';
                        }
                        // Older iPhones
                        else if (height <= 667) {
                            topInset = '20px';
                            bottomInset = '0px';
                        }
                        
                        document.documentElement.style.setProperty('--safe-area-inset-top', topInset);
                        document.documentElement.style.setProperty('--safe-area-inset-bottom', bottomInset);
                        
                        console.log('Safe Area updated:', { height, topInset, bottomInset });
                    }
                },
                
                async requestAccelerometerPermission() {
                    if (!this.isIOS) return Promise.resolve(true);
                    
                    if (typeof DeviceOrientationEvent !== 'undefined' && 
                        typeof DeviceOrientationEvent.requestPermission === 'function') {
                        try {
                            const permission = await DeviceOrientationEvent.requestPermission();
                            const granted = permission === 'granted';
                            console.log('Accelerometer permission:', granted ? 'granted' : 'denied');
                            return granted;
                        } catch (error) {
                            console.error('Accelerometer permission error:', error);
                            return false;
                        }
                    }
                    
                    return Promise.resolve(true);
                },
                
                initializeApp() {
                    // Initialize Menu
                    if (window.Menu && typeof Menu.init === 'function') {
                        Menu.init();
                    }
                    
                    // Initialize Game
                    if (window.Game && typeof Game.init === 'function') {
                        Game.init();
                    }
                    
                    // Setup enhanced button handlers
                    this.setupEnhancedButtonHandlers();
                    
                    // Force safe area update
                    setTimeout(() => this.updateSafeArea(), 300);
                    setTimeout(() => this.updateSafeArea(), 1000);
                    
                    console.log('AppManager: Initialization complete');
                },
                
                setupEnhancedButtonHandlers() {
                    // Use event delegation for all buttons
                    document.addEventListener('click', (e) => {
                        const button = e.target.closest('button');
                        if (!button) return;
                        
                        // Add visual feedback
                        this.addButtonFeedback(button);
                        
                        // Handle data-action attributes
                        const action = button.dataset.action;
                        if (action) {
                            this.handleButtonAction(action, button);
                        }
                        
                        // Handle data-target for back buttons
                        const target = button.dataset.target;
                        if (target && button.classList.contains('back-btn')) {
                            e.preventDefault();
                            if (window.Menu && Menu.switchScreen) {
                                Menu.switchScreen(target);
                            }
                        }
                    });
                    
                    // Setup mobile controls
                    this.setupMobileControls();
                },
                
                addButtonFeedback(button) {
                    // Add active class for visual feedback
                    button.classList.add('active');
                    setTimeout(() => button.classList.remove('active'), 150);
                },
                
                handleButtonAction(action, button) {
                    console.log('Button action:', action, button);
                    
                    if (!window.Menu) return;
                    
                    switch(action) {
                        case 'play':
                            Menu.startGame();
                            break;
                        case 'balls':
                            Menu.switchScreen('balls');
                            break;
                        case 'upgrades':
                            Menu.switchScreen('upgrades');
                            break;
                        case 'settings':
                            Menu.switchScreen('settings');
                            break;
                        case 'select-ball':
                            const ballType = button.dataset.ball;
                            if (ballType) Menu.selectBall(ballType);
                            break;
                        case 'unlock-ball':
                            const unlockBallType = button.dataset.ball;
                            if (unlockBallType) Menu.unlockBall(unlockBallType);
                            break;
                        case 'add-coins':
                            Menu.addCoins(1000);
                            break;
                        case 'reset-progress':
                            if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
                                Menu.resetData();
                            }
                            break;
                        case 'request-accelerometer':
                            this.requestAccelerometerPermission().then(granted => {
                                if (granted) {
                                    Menu.showNotification('Accelerometer enabled!', 'success');
                                    if (window.Game && Game.setupIOSAccelerometer) {
                                        Game.setupIOSAccelerometer();
                                    }
                                } else {
                                    Menu.showNotification('Accelerometer permission denied', 'error');
                                }
                            });
                            break;
                        case 'pause':
                            Menu.togglePause();
                            break;
                        case 'resume':
                            Menu.togglePause();
                            break;
                        case 'restart':
                            Menu.restartGame();
                            break;
                        case 'quit-to-menu':
                            Menu.quitToMenu();
                            break;
                        case 'play-again':
                            Menu.playAgain();
                            break;
                        case 'quit-after-game':
                            Menu.quitAfterGame();
                            break;
                    }
                },
                
                setupMobileControls() {
                    const leftControl = document.getElementById('control-left');
                    const rightControl = document.getElementById('control-right');
                    
                    if (leftControl && rightControl && window.Game) {
                        const handleControl = (direction) => {
                            Game.touchActive = true;
                            Game.touchDirection = direction;
                        };
                        
                        const releaseControl = () => {
                            Game.touchActive = false;
                            Game.touchDirection = 0;
                        };
                        
                        // Touch events
                        leftControl.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            handleControl(-1);
                        });
                        
                        leftControl.addEventListener('touchend', (e) => {
                            e.preventDefault();
                            releaseControl();
                        });
                        
                        rightControl.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            handleControl(1);
                        });
                        
                        rightControl.addEventListener('touchend', (e) => {
                            e.preventDefault();
                            releaseControl();
                        });
                        
                        // Mouse events for desktop testing
                        leftControl.addEventListener('mousedown', () => handleControl(-1));
                        leftControl.addEventListener('mouseup', releaseControl);
                        rightControl.addEventListener('mousedown', () => handleControl(1));
                        rightControl.addEventListener('mouseup', releaseControl);
                        
                        console.log('Mobile controls initialized');
                    }
                },
                
                showNotification(message, type = 'info') {
                    const container = document.getElementById('notification-container');
                    if (!container) return;
                    
                    const notification = document.createElement('div');
                    notification.className = `notification ${type}`;
                    notification.textContent = message;
                    
                    container.appendChild(notification);
                    
                    setTimeout(() => {
                        if (notification.parentNode === container) {
                            container.removeChild(notification);
                        }
                    }, 3000);
                }
            };
            
            // Initialize AppManager when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    window.AppManager.init();
                });
            } else {
                window.AppManager.init();
            }
            
            // Hide address bar on mobile
            window.addEventListener('load', function() {
                setTimeout(function() {
                    window.scrollTo(0, 1);
                }, 0);
            });
            
            // Fix for iOS viewport height
            function updateViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            
            window.addEventListener('resize', updateViewportHeight);
            window.addEventListener('orientationchange', updateViewportHeight);
            updateViewportHeight();
            
        })();
    </script>
    
    <!-- Initialization after page load -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Force recalculation after everything loads
            setTimeout(() => {
                if (window.AppManager && AppManager.updateSafeArea) {
                    AppManager.updateSafeArea();
                }
                if (window.Game && Game.resizeCanvas) {
                    Game.resizeCanvas();
                }
            }, 500);
        });
    </script>
</body>
</html>