<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ball Tower Jumper">

    <!-- Dodaj touch icons dla iOS -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="mask-icon" href="safari-pinned-tab.svg" color="#1a1a2e">
    <meta name="msapplication-TileColor" content="#1a1a2e">
    <meta name="theme-color" content="#1a1a2e">

    <!-- Zmień sekcję PWA w head -->
    <link rel="manifest" href="manifest.json">
    <!-- Dodaj fallback dla iOS -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ball Tower Jumper">
    <title>Ball Tower Jumper</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    
    <!-- Styly dla iOS PWA -->
    <style>
        /* Uniwersalne resetowanie tap-highlight dla iOS standalone */
        body.standalone * {
            -webkit-tap-highlight-color: transparent !important;
        }
        
        body.standalone button,
        body.standalone .hud-btn,
        body.standalone .menu-btn,
        body.standalone .back-btn {
            -webkit-tap-highlight-color: transparent !important;
        }
        
        /* Zapobiegaj zoomowaniu na iOS */
        body.standalone {
            touch-action: pan-x pan-y;
        }
    </style>
</head>
<body>
    <!-- Game Container -->
    <div id="game-container">
        <!-- Start Screen (Main Menu) -->
        <div id="start-screen" class="screen active">
            <div class="title-container">
                <h1 class="game-title">BALL TOWER JUMPER</h1>
                <div class="title-ball"></div>
                <p class="tagline">Play, change balls, buy upgrades!</p>
            </div>
            
            <div class="menu-buttons">
                <button id="play-btn" class="menu-btn">
                    <i class="fas fa-play"></i> Play
                </button>
                <button id="balls-btn" class="menu-btn">
                    <i class="fas fa-basketball-ball"></i> Choose Ball
                </button>
                <button id="upgrades-btn" class="menu-btn">
                    <i class="fas fa-sliders-h"></i> Upgrades
                </button>
                <button id="settings-btn" class="menu-btn">
                    <i class="fas fa-cogs"></i> Settings
                </button>
            </div>
            
            <!-- STATS BAR MOVED TO BOTTOM -->
            <div class="stats-bar">
                <div class="stat">
                    <i class="fas fa-coins"></i>
                    <span id="total-coins">0</span>
                </div>
                <div class="stat">
                    <i class="fas fa-arrow-up"></i>
                    Highscore: <span id="best-score">0</span>
                </div>
                <div class="stat">
                    <i class="fas fa-basketball-ball"></i>
                    Unlocked Balls: <span id="unlocked-balls">1/4</span>
                </div>
            </div>
        </div>
        
        <!-- Ball Selection Screen -->
        <div id="balls-screen" class="screen">
            <div class="screen-header">
                <button class="back-btn"><i class="fas fa-arrow-left"></i> Back</button>
                <div class="header-actions">
                        <h2><i class="fas fa-basketball-ball"></i> Choose ball</h2>
                    <div class="coins-display">
                        <i class="fas fa-coins"></i> <span id="balls-coins">0</span>
                    </div>
                </div>
            </div>
            
            <div class="balls-container">
                <!-- Standard ball -->
                <div class="ball-card active" data-ball="standard">
                    <div class="ball-preview standard-ball"></div>
                    <h3>Standard</h3>
                    <p>Standard ball, normal physics, perfect for start</p>
                    <div class="ball-stats">
                    </div>
                    <button class="select-ball-btn">Selected</button>
                </div>
                
                <!-- Rubber ball -->
                <div class="ball-card locked" data-ball="rubber">
                    <div class="ball-preview rubber-ball">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h3>Gumball</h3>
                    <p>High Wall Boost</p>
                    <div class="ball-stats">
                    </div>
                    <button class="unlock-btn" data-cost="50">Unlock for 50 <i class="fas fa-coins"></i></button>
                </div>
                
                <!-- Beach ball -->
                <div class="ball-card locked" data-ball="beach">
                    <div class="ball-preview beach-ball">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h3>Beach Ball</h3>
                    <p>Sensitive to wind</p>
                    <button class="unlock-btn" data-cost="100">Unlock for 100 <i class="fas fa-coins"></i></button>
                </div>
                
                <!-- Golf ball -->
                <div class="ball-card locked" data-ball="golf">
                    <div class="ball-preview golf-ball">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h3>Golf</h3>
                    <p>Cannon Access</p>
                    <button class="unlock-btn" data-cost="150">Unlock for 150 <i class="fas fa-coins"></i></button>
                </div>
            </div>
            
            <div class="selected-ball-info">
                <h3>Selected ball: <span id="current-ball-name">Standard</span></h3>
            </div>
        </div>
        
        <!-- Upgrades Screen -->
        <div id="upgrades-screen" class="screen">
            <div class="screen-header">
                <button class="back-btn"><i class="fas fa-arrow-left"></i> Back</button>
                <div class="header-actions">
                        <h2><i class="fas fa-cogs"></i> Upgrades</h2>
                    <div class="coins-display">
                        <i class="fas fa-coins"></i> <span id="upgrades-coins">0</span>
                    </div>
                </div>
            </div>
            
            <div class="ball-selector">
                <h3>Select ball to upgrade:</h3>
                <div class="ball-selector-buttons">
                    <!-- Ball selection buttons will be generated dynamically -->
                </div>
            </div>
            
            <div id="upgrades-list">
                <!-- Upgrades list will be generated dynamically -->
            </div>
            
            <div class="upgrades-info">
                <p><i class="fas fa-info-circle"></i> Upgrades can be enabled/disabled before starting the game. They are specific to each ball.</p>
            </div>
        </div>
        
        <!-- Settings Screen -->
        <div id="settings-screen" class="screen">
            <div class="screen-header">
                <button class="back-btn"><i class="fas fa-arrow-left"></i> Back</button>
                <h2><i class="fas fa-sliders-h"></i> Settings</h2>
            </div>
            
            <div class="settings-content">
                <div class="settings-section">
                    <h3><i class="fas fa-gamepad"></i> Controls</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Auto jump</h4>
                            <p>Ball jumps automatically after landing</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="auto-jump-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Mobile controls</h4>
                            <p>Enable touch controls (left/right side of screen)</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="mobile-controls-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Accelerometer</h4>
                            <p>Use device tilt to control</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="accelerometer-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Show wind</h4>
                            <p>Display wind direction and strength arrow</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="wind-display-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3><i class="fas fa-bug"></i> Debug</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Show debug info</h4>
                            <p>Show debugging information during the game</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="debug-info-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Add coins (debug)</h4>
                            <p>Add 1000 coins to test purchases</p>
                        </div>
                        <button id="add-coins-btn" class="debug-btn">
                            <i class="fas fa-coins"></i> Add 1000 coins
                        </button>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Reset progress</h4>
                            <p>Delete all saved data and start over</p>
                        </div>
                        <button id="reset-progress-btn" class="danger-btn">
                            <i class="fas fa-trash"></i> Reset progress
                        </button>
                    </div>
                    <!-- W pliku index.html, w sekcji ustawień dodaj: -->
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Request Accelerometer Access</h4>
                            <p>Tap to enable tilt controls on iOS</p>
                        </div>
                        <button id="request-accelerometer-btn" class="debug-btn">
                            <i class="fas fa-compass"></i> Request Access
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <canvas id="game-canvas"></canvas>
            
            <!-- Debug elements from the first project -->
            <div id="debug-info" class="debug-info hidden">
                <div id="height-display">Height: <span id="height">0</span>px</div>
                <div id="max-height-display">Max height: <span id="max-height">0</span>px</div>
                <div id="velocity-x-display">Velocity X: <span id="velocity-x">0</span>px/frame</div>
                <div id="max-velocity-x-display">Max velocity X: <span id="max-velocity-x">0</span>px/frame</div>
                <div id="velocity-y-display">Velocity Y (up): <span id="velocity-y">0</span>px/frame</div>
                <div id="max-velocity-y-display">Max velocity Y (up): <span id="max-velocity-y">0</span>px/frame</div>
                <div id="current-floor-display">Current floor: <span id="current-floor">0</span></div>
                <div id="max-floor-display">Highest floor: <span id="max-floor">0</span></div>
                <div id="high-score-display">High score: <span id="high-score">0</span></div>
            </div>
            
            <!-- SIMPLIFIED GAME HUD -->
            <div id="game-hud">
                <!-- Top HUD bar -->
                <div class="hud-top">
                    <div class="hud-left">
                        <button id="pause-btn" class="hud-btn" title="Pause (P)">
                            <i class="fas fa-pause"></i>
                        </button>
                    </div>
                    
                    <div class="hud-center">
                        <div class="score-display">
                            Score: <span id="score-value">0</span>
                        </div>
                    </div>
                    
                    <div class="hud-right">
                        <div class="hud-item">
                            <i class="fas fa-coins"></i>
                            <span id="coins-value">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile Controls Overlay -->
                <div id="mobile-controls-overlay" class="mobile-controls-overlay">
                    <div class="control-left" id="control-left"></div>
                    <div class="control-right" id="control-right"></div>
                </div>
            </div>
            
            <!-- Pause menu -->
            <div id="pause-menu" class="overlay-menu hidden">
                <div class="overlay-background"></div> <!-- Added background -->
                <div class="pause-content">
                    <h2><i class="fas fa-pause"></i> Game Paused</h2>
                    <div class="pause-stats">
                        <div class="stat-box">
                            <h3>Score</h3>
                            <p class="stat-value" id="pause-score">0</p>
                        </div>
                        <div class="stat-box">
                            <h3>Coins</h3>
                            <p class="stat-value" id="pause-coins">0</p>
                        </div>
                        <div class="stat-box">
                            <h3>Ball</h3>
                            <p class="stat-value" id="pause-ball">Standard</p>
                        </div>
                    </div>
                    <div class="pause-buttons">
                        <button id="resume-btn" class="pause-btn">
                            <i class="fas fa-play"></i> Resume Game
                        </button>
                        <button id="restart-btn" class="pause-btn">
                            <i class="fas fa-redo"></i> Start Over
                        </button>
                        <button id="quit-to-menu-btn" class="pause-btn">
                            <i class="fas fa-home"></i> Exit to Menu
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Game over screen -->
            <div id="game-over-screen" class="overlay-menu hidden">
                <div class="overlay-background"></div> <!-- Added background -->
                <div class="game-over-content">
                    <h2><i class="fas fa-skull-crossbones"></i> Fell!</h2>
                    <div class="game-over-stats">
                        <div class="stat-box">
                            <h3>Your Score</h3>
                            <p class="stat-value" id="final-score">0</p>
                        </div>
                        <div class="stat-box">
                            <h3>Coins Collected</h3>
                            <p class="stat-value" id="final-coins">0</p>
                        </div>
                        <div class="stat-box">
                            <h3>High Score</h3>
                            <p class="stat-value" id="final-highscore">0</p>
                        </div>
                    </div>
                    
                    <div class="game-over-buttons">
                        <button id="play-again-btn" class="game-over-btn">
                            <i class="fas fa-redo"></i> Play Again
                        </button>
                        <button id="quit-after-game-btn" class="game-over-btn">
                            <i class="fas fa-home"></i> Main Menu
                        </button>
                    </div>
                    
                    <div class="game-over-message">
                        <p id="game-over-message-text">Try again!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notifications -->
    <div id="notification-container"></div>
    
    <!-- JavaScript Scripts -->
    <script src="js/config.js"></script>
    <script src="js/menu.js"></script>
    <script src="js/game.js"></script>
    

    <!-- Enhanced PWA and iOS Standalone Script -->
<!-- Enhanced PWA and iOS Standalone Script -->
    <script>
        // Rejestracja Service Worker dla PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    
        // Globalna zmienna do śledzenia stanu standalone
        window.isStandalone = false;
        
        // Rozwiązanie dla fullscreen na iOS
        document.addEventListener('DOMContentLoaded', () => {
            // Sprawdź czy jesteśmy w trybie standalone
            if (window.navigator.standalone) {
                document.body.classList.add('standalone');
                window.isStandalone = true;
                console.log('Running in standalone mode (added to home screen)');
            } else {
                console.log('Running in browser mode');
                window.isStandalone = false;
            }
            
            // Fix dla iOS scroll - tylko dla elementów które nie są interaktywne
            document.addEventListener('touchmove', function(e) {
                if(e.target.type === 'range' || 
                   e.target.tagName === 'BUTTON' || 
                   e.target.tagName === 'INPUT' ||
                   e.target.tagName === 'SELECT' ||
                   e.target.isContentEditable) {
                    return;
                }
                e.preventDefault();
            }, { passive: false });
        
            // Fix dla iOS zoom
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
        
            // Inicjalizacja safe area
            updateSafeArea();
            
            // Rozwiązanie problemu z przyciskami w standalone mode
            setTimeout(() => {
                if (window.isStandalone) {
                    setupUniversalEventDelegation();
                }
            }, 300);
        });
    
        // Rozwiązanie dla safe area dynamicznie
        function updateSafeArea() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
            
            if (CSS.supports('padding-top: env(safe-area-inset-top)')) {
                document.documentElement.style.setProperty('--safe-area-inset-top', 'env(safe-area-inset-top)');
                document.documentElement.style.setProperty('--safe-area-inset-bottom', 'env(safe-area-inset-bottom)');
                document.documentElement.style.setProperty('--safe-area-inset-left', 'env(safe-area-inset-left)');
                document.documentElement.style.setProperty('--safe-area-inset-right', 'env(safe-area-inset-right)');
            }
        }
    
        // UNIWERSALNA EVENT DELEGATION DLA WSZYSTKICH PRZYCISKÓW W STANDALONE
        function setupUniversalEventDelegation() {
            console.log('Setting up universal event delegation for standalone mode');
            
            // Usuń wszystkie istniejące event listeners z przycisków przez klonowanie
            document.querySelectorAll('button').forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
            });
            
            // Globalny event listener dla WSZYSTKICH kliknięć
            document.addEventListener('click', function(e) {
                if (!window.isStandalone) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                const target = e.target;
                const button = target.closest('button');
                if (!button) return;
                
                console.log('Standalone click detected:', {
                    id: button.id,
                    className: button.className,
                    text: button.textContent?.trim()
                });
                
                // Obsługa z opóźnieniem (dla iOS)
                setTimeout(() => handleStandaloneButtonClick(button), 10);
                
                return false;
            }, true);
            
            // Touch events dla iOS
            document.addEventListener('touchstart', function(e) {
                if (!window.isStandalone) return;
                
                const target = e.target;
                const button = target.closest('button');
                if (!button) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                // Symuluj kliknięcie
                setTimeout(() => handleStandaloneButtonClick(button), 10);
                
                return false;
            }, { passive: false });
        }
    
        // GŁÓWNA FUNKCJA OBSŁUGUJĄCA WSZYSTKIE PRZYCISKI
        function handleStandaloneButtonClick(button) {
            console.log('Handling standalone button click:', button.id || button.className);
            
            // Upewnij się, że Menu jest dostępne
            if (!window.Menu) {
                console.error('Menu not available');
                return;
            }
            
            const buttonId = button.id;
            const buttonClass = button.className;
            
            // 1. PRZYCISKI MENU GŁÓWNEGO
            if (buttonId === 'play-btn') {
                console.log('Play button clicked in standalone');
                window.Menu.startGame();
                return;
            }
            
            if (buttonId === 'balls-btn') {
                console.log('Balls button clicked in standalone');
                window.Menu.switchScreen('balls');
                return;
            }
            
            if (buttonId === 'upgrades-btn') {
                console.log('Upgrades button clicked in standalone');
                window.Menu.switchScreen('upgrades');
                return;
            }
            
            if (buttonId === 'settings-btn') {
                console.log('Settings button clicked in standalone');
                window.Menu.switchScreen('settings');
                return;
            }
            
            // 2. PRZYCISKI EKRANU PIŁEK
            if (buttonClass.includes('select-ball-btn')) {
                const ballCard = button.closest('.ball-card');
                if (ballCard) {
                    const ballType = ballCard.dataset.ball;
                    console.log('Select ball button clicked:', ballType);
                    window.Menu.selectBall(ballType);
                }
                return;
            }
            
            if (buttonClass.includes('unlock-btn')) {
                const ballCard = button.closest('.ball-card');
                if (ballCard) {
                    const ballType = ballCard.dataset.ball;
                    console.log('Unlock ball button clicked:', ballType);
                    window.Menu.unlockBall(ballType);
                }
                return;
            }
            
            // 3. PRZYCISKI EKRANU ULEPSZEŃ
            if (buttonClass.includes('buy-btn') && !button.disabled) {
                // Pobierz ID ulepszenia z atrybutu onclick
                const onClickAttr = button.getAttribute('onclick');
                if (onClickAttr) {
                    const match = onClickAttr.match(/['"]([^'"]+)['"]/);
                    if (match && match[1]) {
                        const upgradeId = match[1];
                        const ballType = window.Menu.state.currentBall;
                        console.log('Buy upgrade button clicked:', upgradeId, 'for ball:', ballType);
                        window.Menu.buyUpgrade(ballType, upgradeId);
                    }
                }
                return;
            }
            
            if (buttonClass.includes('toggle-btn')) {
                const onClickAttr = button.getAttribute('onclick');
                if (onClickAttr) {
                    const match = onClickAttr.match(/['"]([^'"]+)['"]/);
                    if (match && match[1]) {
                        const upgradeId = match[1];
                        const ballType = window.Menu.state.currentBall;
                        console.log('Toggle upgrade button clicked:', upgradeId);
                        window.Menu.toggleUpgrade(ballType, upgradeId);
                    }
                }
                return;
            }
            
            if (buttonClass.includes('ball-select-btn') && !buttonClass.includes('active')) {
                const ballName = button.textContent.trim();
                console.log('Ball select button clicked:', ballName);
                
                // Znajdź typ piłki na podstawie nazwy
                const ballTypes = ['standard', 'rubber', 'beach', 'golf'];
                const ballDisplayNames = ballTypes.map(type => GameConfig.getBallDisplayName(type));
                const ballIndex = ballDisplayNames.findIndex(name => name === ballName);
                
                if (ballIndex !== -1) {
                    const ballType = ballTypes[ballIndex];
                    window.Menu.state.currentBall = ballType;
                    window.Menu.updateUpgradesScreen();
                }
                return;
            }
            
            // 4. PRZYCISKI USTAWIEN
            if (buttonId === 'add-coins-btn') {
                console.log('Add coins button clicked');
                window.Menu.state.totalCoins += 1000;
                window.Menu.saveData();
                window.Menu.updateCoinsDisplay();
                window.Menu.showNotification('Added 1000 coins!', 'success');
                return;
            }
            
            if (buttonId === 'reset-progress-btn') {
                console.log('Reset progress button clicked');
                if (confirm('Are you sure you want to reset all progress? This action cannot be undone.')) {
                    window.Menu.resetData();
                    window.Menu.updateMainMenu();
                    window.Menu.showNotification('All data has been reset', 'warning');
                }
                return;
            }
            
            if (buttonId === 'request-accelerometer-btn') {
                console.log('Request accelerometer button clicked');
                // Ta funkcja powinna być zdefiniowana w menu.js
                if (window.Menu && window.Menu.requestAccelerometerAccess) {
                    window.Menu.requestAccelerometerAccess();
                }
                return;
            }
            
            // 5. PRZYCISKI PAUZY
            if (buttonId === 'pause-btn') {
                console.log('Pause button clicked');
                if (window.Menu) window.Menu.togglePause();
                return;
            }
            
            if (buttonId === 'resume-btn') {
                console.log('Resume button clicked');
                if (window.Menu) window.Menu.togglePause();
                return;
            }
            
            if (buttonId === 'restart-btn') {
                console.log('Restart button clicked');
                if (window.Menu) {
                    window.Menu.saveGameProgress(true);
                    window.Menu.state.coinsInGame = 0;
                    document.getElementById('pause-menu').classList.add('hidden');
                    window.Menu.startGame();
                }
                return;
            }
            
            if (buttonId === 'quit-to-menu-btn') {
                console.log('Quit to menu button clicked');
                if (window.Menu) {
                    window.Menu.saveGameProgress(true);
                    window.Menu.state.coinsInGame = 0;
                    document.getElementById('pause-menu').classList.add('hidden');
                    window.Menu.switchScreen('start');
                }
                return;
            }
            
            // 6. PRZYCISKI GAME OVER
            if (buttonId === 'play-again-btn') {
                console.log('Play again button clicked');
                if (window.Menu) {
                    window.Menu.saveGameProgress(false);
                    window.Menu.state.coinsInGame = 0;
                    document.getElementById('game-over-screen').classList.add('hidden');
                    window.Menu.startGame();
                }
                return;
            }
            
            if (buttonId === 'quit-after-game-btn') {
                console.log('Quit after game button clicked');
                document.getElementById('game-over-screen').classList.add('hidden');
                window.Menu.switchScreen('start');
                return;
            }
            
            // 7. PRZYCISKI POWROTU (BACK)
            if (buttonClass.includes('back-btn')) {
                console.log('Back button clicked');
                window.Menu.switchScreen('start');
                return;
            }
            
            console.log('Unhandled button click:', buttonId, buttonClass);
        }
    
        // Rozwiązanie dla białego paska w Safari
        function fixSafariWhiteBar() {
            if (!window.isStandalone && /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent)) {
                console.log('Fixing Safari white bar issue');
                
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    document.body.style.height = `${window.innerHeight}px`;
                }, 100);
                
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => {
                        const newVh = window.innerHeight * 0.01;
                        document.documentElement.style.setProperty('--vh', `${newVh}px`);
                        document.body.style.height = `${window.innerHeight}px`;
                        window.scrollTo(0, 0);
                    }, 300);
                });
            }
        }
    
        // Event listeners dla zmiany rozmiaru
        window.addEventListener('resize', updateSafeArea);
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                updateSafeArea();
                fixSafariWhiteBar();
                if (window.Game && Game.resizeCanvas) {
                    Game.resizeCanvas();
                }
            }, 100);
        });
        
        // Initial call
        setTimeout(() => {
            updateSafeArea();
            fixSafariWhiteBar();
        }, 100);
        
        // Ukryj pasek adresu na mobilnych urządzeniach
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (!window.isStandalone) {
                    window.scrollTo(0, 1);
                }
            }, 0);
        });
        
        // Zapobiegaj domyślnemu menu kontekstowemu w standalone
        document.addEventListener('contextmenu', function(e) {
            if (window.isStandalone) {
                e.preventDefault();
                return false;
            }
        });
        
        // Dodatkowa inicjalizacja po załadowaniu
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (window.isStandalone) {
                    console.log('Re-initializing standalone mode...');
                    setupUniversalEventDelegation();
                    
                    // Wymuś ciemne tło dla safe area
                    document.documentElement.style.backgroundColor = '#0a0a1a';
                    document.body.style.backgroundColor = '#0a0a1a';
                    
                    // Ukryj pasek adresu (jeśli jeszcze widoczny)
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                    }, 100);
                }
            }, 1000);
        });
    </script>
    
    <!-- Initialization after page load -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize menu
            if (window.Menu) Menu.init();
            
            // Force recalculation after everything loads
            setTimeout(() => {
                updateSafeArea();
                fixSafariWhiteBar();
                if (window.Game && Game.resizeCanvas) {
                    Game.resizeCanvas();
                }
                
                // Dodatkowe optymalizacje dla standalone
                if (document.body.classList.contains('standalone')) {
                    // Wymuś ciemne tło dla safe area
                    document.documentElement.style.backgroundColor = '#0a0a1a';
                    document.body.style.backgroundColor = '#0a0a1a';
                    
                    // Ukryj pasek adresu (jeśli jeszcze widoczny)
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                    }, 100);
                }
            }, 300);
        });
    </script>
</body>
</html>